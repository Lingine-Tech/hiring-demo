{"version":3,"file":"index.mjs","names":["normalizePrefix","manifest: Array<{\n    fileName: string\n    url: string\n    key: string\n    hostId?: string\n    hostType?: string\n    size: number\n  }>","resolvedConfig: ResolvedConfig | undefined","pendingUploads: Array<{\n    fileName: string\n    key: string\n    localPath: string\n    contentType?: string\n  }>","renderBuiltUrl: RenderBuiltAssetUrl","uploads: Array<Promise<void>>"],"sources":["../src/providers/s3.ts","../src/index.ts"],"sourcesContent":["import type { Buffer } from 'node:buffer'\n\nimport type { UploadProvider } from './types'\n\nimport { createHash } from 'node:crypto'\nimport { readFile } from 'node:fs/promises'\n\nimport { S3mini } from 's3mini'\n\nexport interface S3ProviderOptions {\n  endpoint: string\n  accessKeyId: string\n  secretAccessKey: string\n  region?: string\n  requestSizeInBytes?: number\n  requestAbortTimeout?: number\n  /**\n   * Skip uploading when the remote object ETag matches the local content hash (MD5). Enabled by default.\n   */\n  skipNotModified?: boolean\n  /**\n   * Public base URL used in rewritten assets. Defaults to endpoint.\n   */\n  publicBaseUrl?: string\n}\n\nexport function createS3Provider(options: S3ProviderOptions): UploadProvider {\n  const client = new S3mini({\n    accessKeyId: options.accessKeyId,\n    secretAccessKey: options.secretAccessKey,\n    endpoint: options.endpoint,\n    region: options.region ?? 'auto',\n    requestAbortTimeout: options.requestAbortTimeout,\n    requestSizeInBytes: options.requestSizeInBytes,\n  })\n\n  const publicBaseUrl = options.publicBaseUrl ?? options.endpoint\n  const skipNotModified = options.skipNotModified !== false\n\n  return {\n    async upload(localPath: string, key: string, contentType?: string) {\n      const data = await readFile(localPath)\n      await client.putObject(normalizeKey(key), data, contentType ?? 'application/octet-stream')\n    },\n    async cleanPrefix(prefix: string) {\n      const normalizedPrefix = normalizePrefix(prefix)\n      if (!normalizedPrefix)\n        return\n\n      const objects = await client.listObjects('/', `${normalizedPrefix}/`)\n      if (!objects?.length)\n        return\n\n      const keys = objects.map(obj => obj.Key)\n      await client.deleteObjects(keys)\n    },\n    async shouldSkipUpload(localPath: string, key: string) {\n      if (!skipNotModified)\n        return false\n\n      const data = await readFile(localPath)\n      return isMd5HashMatched(client, key, data)\n    },\n    getPublicUrl(key: string) {\n      return joinUrl(publicBaseUrl, key)\n    },\n  }\n}\n\nasync function isMd5HashMatched(client: S3mini, key: string, data: Buffer) {\n  try {\n    const etag = await client.getEtag(normalizeKey(key))\n    if (!etag)\n      return false\n\n    const normalizedEtag = sanitizeEtag(etag)\n    if (!normalizedEtag || normalizedEtag.includes('-'))\n      return false\n\n    const localHash = createHash('md5').update(data).digest('hex')\n    return normalizedEtag.toLowerCase() === localHash.toLowerCase()\n  }\n  catch {\n    return false\n  }\n}\n\nfunction normalizePrefix(prefix: string) {\n  return prefix.replace(/^\\/*/, '').replace(/\\/*$/, '')\n}\n\nfunction normalizeKey(key: string) {\n  return key.replace(/^\\/*/, '')\n}\n\nfunction joinUrl(base: string, path: string) {\n  return `${base.replace(/\\/+$/, '')}/${path.replace(/^\\/+/, '')}`\n}\n\nfunction sanitizeEtag(etag: string) {\n  return etag.replace(/^\"+|\"+$/g, '')\n}\n","import type { OutputAsset } from 'rollup'\nimport type { Plugin, RenderBuiltAssetUrl, ResolvedConfig } from 'vite'\n\nimport type { UploadProvider } from './providers/types'\n\nimport { Buffer } from 'node:buffer'\nimport { rm } from 'node:fs/promises'\nimport { join, resolve } from 'node:path'\nimport { cwd } from 'node:process'\n\nexport { createS3Provider } from './providers/s3'\nexport type { S3ProviderOptions } from './providers/s3'\nexport type { UploadProvider } from './providers/types'\n\ntype IncludeMatcher = RegExp | ((filename: string) => boolean)\n\nexport interface WarpDrivePluginOptions {\n  provider: UploadProvider\n  /**\n   * Prefix to prepend before the asset filename when uploading and when rewriting URLs.\n   * e.g. `remote-assets` will produce `remote-assets/assets/duckdb-eh-123.wasm`.\n   */\n  prefix?: string\n  /**\n   * Restrict which assets are rewritten/uploaded.\n   */\n  include?: IncludeMatcher[]\n  /**\n   * Optional extra predicate that receives filename + host info to decide inclusion.\n   */\n  includeBy?: (filename: string, ctx: { hostId?: string, hostType?: string }) => boolean\n  /**\n   * Optional content-type resolver. If omitted, uploads use the provider default.\n   */\n  contentTypeBy?: (filename: string) => Promise<string | undefined> | string | undefined\n  /**\n   * Emit a manifest with module id + URL for debugging.\n   */\n  manifest?: boolean\n  /**\n   * Delete the uploaded local asset from disk after upload completes. Enabled by default.\n   */\n  delete?: boolean\n  /**\n   * Clean the remote prefix before uploading (delete existing objects). Enabled by default.\n   */\n  clean?: boolean\n  /**\n   * When enabled, skip cleaning and uploading; emit manifest/rewrite URLs only.\n   */\n  dryRun?: boolean\n  /**\n   * Skip uploading assets that are already present and not modified. Enabled by default when supported.\n   */\n  skipNotModified?: boolean\n}\n\nexport function WarpDrivePlugin(options: WarpDrivePluginOptions): Plugin {\n  const include = options.include ?? []\n  const prefix = normalizePrefix(options.prefix ?? 'remote-assets')\n  const pluginName = 'proj-airi-warpdrive'\n  const shouldDeleteLocalAsset = options.delete !== false\n  const shouldCleanRemote = options.clean !== false\n  const shouldSkipNotModified = options.skipNotModified !== false\n  const isDryRun = options.dryRun === true\n\n  const tracked = new Map<string, { key: string, url: string, hostId?: string, hostType?: string }>()\n  const manifest: Array<{\n    fileName: string\n    url: string\n    key: string\n    hostId?: string\n    hostType?: string\n    size: number\n  }> = []\n\n  let resolvedConfig: ResolvedConfig | undefined\n  let cleanedRemote = false\n  const pendingUploads: Array<{\n    fileName: string\n    key: string\n    localPath: string\n    contentType?: string\n  }> = []\n\n  const shouldHandle = (filename: string, ctx: { hostId?: string, hostType?: string }) => {\n    const includeMatch = include.some((matcher) => {\n      if (matcher instanceof RegExp)\n        return matcher.test(filename)\n\n      return matcher(filename)\n    })\n\n    if (!includeMatch)\n      return false\n    if (options.includeBy)\n      return options.includeBy(filename, ctx)\n\n    return true\n  }\n\n  const renderBuiltUrl: RenderBuiltAssetUrl = (filename, ctx) => {\n    if (!shouldHandle(filename, ctx))\n      return\n    if (!options.provider)\n      return\n\n    const key = prefix ? `${prefix}/${filename}` : filename\n    const url = options.provider.getPublicUrl(key)\n\n    tracked.set(filename, {\n      key,\n      url,\n      hostId: ctx.hostId,\n      hostType: ctx.hostType,\n    })\n\n    return url\n  }\n\n  return {\n    name: pluginName,\n    apply: 'build',\n    enforce: 'post',\n    config: () => {\n      return {\n        experimental: {\n          renderBuiltUrl,\n        },\n      }\n    },\n    configResolved(config) {\n      resolvedConfig = config\n    },\n    async generateBundle(_, bundle) {\n      if (!resolvedConfig) {\n        console.warn?.(`[${pluginName}] Vite config not resolved, skipping upload step`)\n        return\n      }\n      if (!options.provider) {\n        resolvedConfig.logger.warn(`[${pluginName}] no upload provider configured, skipping upload step`)\n        return\n      }\n\n      const root = resolvedConfig.root || cwd()\n      const outDir = resolve(root, resolvedConfig.build.outDir)\n\n      for (const [fileName, output] of Object.entries(bundle)) {\n        if (output.type !== 'asset')\n          continue\n\n        const trackedMeta = tracked.get(fileName)\n        if (!trackedMeta)\n          continue\n\n        const key = trackedMeta.key\n        const url = trackedMeta.url\n        const localPath = join(outDir, fileName)\n        const size = getAssetSize(output)\n        const contentType = await options.contentTypeBy?.(fileName)\n\n        manifest.push({\n          fileName,\n          url,\n          key,\n          hostId: trackedMeta.hostId,\n          hostType: trackedMeta.hostType,\n          size,\n        })\n\n        pendingUploads.push({ fileName, key, localPath, contentType })\n        resolvedConfig.logger.info(`[${pluginName}] scheduled uploading: ${fileName} -> ${key} (${size} bytes)`)\n      }\n\n      if (options.manifest && manifest.length) {\n        this.emitFile({\n          type: 'asset',\n          fileName: 'remote-assets.manifest.json',\n          source: JSON.stringify({ assets: manifest }, null, 2),\n        })\n      }\n    },\n    async closeBundle() {\n      if (!resolvedConfig) {\n        console.warn?.(`[${pluginName}] Vite config not resolved, skipping upload step`)\n        return\n      }\n      if (!options.provider) {\n        resolvedConfig.logger.warn(`[${pluginName}] no upload provider configured, skipping upload step`)\n        return\n      }\n      if (!pendingUploads.length)\n        return\n      if (isDryRun) {\n        resolvedConfig.logger.info(\n          `[${pluginName}] dry run enabled; skipping clean/upload for ${pendingUploads.length} assets`,\n        )\n        return\n      }\n\n      if (shouldCleanRemote && !cleanedRemote) {\n        if (!prefix) {\n          resolvedConfig.logger.warn(`[${pluginName}] skipping clean step because no prefix provided`)\n        }\n        else if (typeof options.provider.cleanPrefix === 'function') {\n          resolvedConfig.logger.info(`[${pluginName}] cleaning remote prefix: ${prefix}`)\n          await options.provider.cleanPrefix(prefix)\n          resolvedConfig.logger.info(`[${pluginName}] cleaned remote prefix: ${prefix}`)\n          cleanedRemote = true\n        }\n        else {\n          resolvedConfig.logger.warn(\n            `[${pluginName}] clean is enabled but provider does not support prefix cleaning; skipping`,\n          )\n        }\n      }\n\n      resolvedConfig.logger.info(`[${pluginName}] uploading ${pendingUploads.length} assets to remote storage...`)\n      const uploads: Array<Promise<void>> = []\n\n      for (const { fileName, key, localPath, contentType } of pendingUploads) {\n        uploads.push((async () => {\n          if (shouldSkipNotModified && typeof options.provider.shouldSkipUpload === 'function') {\n            try {\n              const skip = await options.provider.shouldSkipUpload(localPath, key)\n              if (skip) {\n                resolvedConfig.logger.info(\n                  `[${pluginName}] skipped upload (not modified): ${fileName} -> ${key}`,\n                )\n                if (shouldDeleteLocalAsset) {\n                  try {\n                    await rm(localPath, { force: true })\n                    resolvedConfig.logger.info(`[${pluginName}] deleted local asset: ${fileName}`)\n                  }\n                  catch (error) {\n                    resolvedConfig.logger.warn(`[${pluginName}] failed to delete local asset ${fileName}: ${error}`)\n                  }\n                }\n                return\n              }\n            }\n            catch (error) {\n              resolvedConfig.logger.warn(\n                `[${pluginName}] could not determine if upload should be skipped for ${fileName}: ${error}`,\n              )\n            }\n          }\n          try {\n            await options.provider.upload(localPath, key, contentType)\n          }\n          catch (error) {\n            resolvedConfig.logger.error(`[${pluginName}] upload failed, file: ${fileName} -> ${key}: ${error}`, { error })\n            throw error\n          }\n\n          if (shouldDeleteLocalAsset) {\n            try {\n              await rm(localPath, { force: true })\n              resolvedConfig.logger.info(`[${pluginName}] deleted local asset: ${fileName}`)\n            }\n            catch (error) {\n              resolvedConfig.logger.warn(`[${pluginName}] failed to delete local asset ${fileName}: ${error}`)\n            }\n          }\n        })())\n      }\n\n      await Promise.all(uploads)\n      resolvedConfig.logger.info(`[${pluginName}] upload complete`)\n    },\n  }\n}\n\nfunction normalizePrefix(prefix: string) {\n  return prefix.replace(/^\\/*/, '').replace(/\\/*$/, '')\n}\n\nfunction getAssetSize(asset: OutputAsset) {\n  if (typeof asset.source === 'string')\n    return Buffer.byteLength(asset.source)\n\n  return asset.source?.byteLength ?? 0\n}\n"],"mappings":"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"}